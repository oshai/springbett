angular.module("security", []).constant("security.urls", { site: "/", manage: "/manage", join: "/api/account/register", login: "/token", logout: "/api/account/logout", forgotPassword: "/api/account/forgotpassword", resetPassword: "/api/account/resetpassword", confirmEmail: "/api/account/confirmEmail", userInfo: "/api/account/userInfo", changePassword: "/api/account/changePassword", externalLogins: "/api/account/externalLogins", manageInfo: "/api/account/manageInfo", registerExternal: "/api/account/registerExternal", addExternalLogin: "/api/account/addExternalLogin", removeLogin: "/api/account/removeLogin" }).factory("security.api", ["$http", "security.urls", function (e, r) { var n = { "Content-Type": "application/x-www-form-urlencoded" }, o = function (e) { var r = function (e) { var n, o, t, a, s = ""; return angular.forEach(e, function (e, i) { if (e instanceof Array) for (a = 0; a < e.length; ++a) n = e[a], o = i + "[" + a + "]", t = {}, t[o] = n, s += r(t) + "&"; else e instanceof Object ? angular.forEach(e, function (e, n) { o = i + "[" + n + "]", t = {}, t[o] = e, s += r(t) + "&" }) : void 0 !== e && null !== e && (s += encodeURIComponent(i) + "=" + encodeURIComponent(e) + "&") }), s.length ? s.substr(0, s.length - 1) : s }; return angular.isObject(e) && "[object File]" !== String(e) ? r(e) : e }, t = { getUserInfo: function (n) { return e({ url: r.userInfo, method: "GET", headers: { Authorization: "Bearer " + n } }) }, login: function (t) { return e({ method: "POST", url: r.login, data: o(t), headers: n }) }, logout: function () { return e({ method: "POST", url: r.logout }) }, register: function (n) { return e({ method: "POST", url: r.join, data: n }) }, forgotPassword: function (n) { return e({ method: "POST", url: r.forgotPassword, data: n }) }, resetPassword: function (n) { return e({ method: "POST", url: r.resetPassword, data: n }) }, confirmEmail: function (n) { return e({ method: "GET", url: r.confirmEmail + "?code=" + encodeURIComponent(n.code) + "&userId=" + encodeURIComponent(n.userId) }) }, changePassword: function (n) { return e({ method: "POST", url: r.changePassword, data: n }) }, getExternalLogins: function () { return e({ method: "GET", url: r.externalLogins + "?returnUrl=" + encodeURIComponent(r.site) + "&generateState=true", isArray: !0 }) }, manageInfo: function () { return e({ method: "GET", url: r.manageInfo + "?returnUrl=" + encodeURIComponent(r.site) + "&generateState=false" }) }, registerExternal: function (n, o) { return e({ method: "POST", url: r.registerExternal, data: o, headers: { Authorization: "Bearer " + n } }) }, addExternalLogin: function (n, o) { return e({ method: "POST", url: r.addExternalLogin, data: { externalAccessToken: o }, headers: { Authorization: "Bearer " + n } }) }, removeLogin: function (n) { return e({ method: "POST", url: r.removeLogin, data: n }) } }; return t }]).provider("security", ["security.urls", function (e) { var r = this; r.registerThenLogin = !0, r.usePopups = !1, r.urls = { login: "/login", registerExternal: "/registerExternal", postLogout: "/login", home: "/" }, r.apiUrls = e, r.events = { login: null, logout: null, register: null, reloadUser: null, closeOAuthWindow: null }, r.$get = ["security.api", "$q", "$http", "$location", "$timeout", function (e, n, o, t, a) { var s = null, i = function (e) { var r, n, o, t, a, s, i, c = {}; if (null === e) return c; r = e.split("&"); for (var l = 0; l < r.length; l++) n = r[l], o = n.indexOf("="), -1 === o ? (t = n, a = null) : (t = n.substr(0, o), a = n.substr(o + 1)), s = decodeURIComponent(t), i = decodeURIComponent(a), c[s] = i; return c }, c = function (e, r) { return e && ("clear" == e ? (localStorage.removeItem("accessToken"), sessionStorage.removeItem("accessToken"), delete o.defaults.headers.common.Authorization) : (r ? localStorage.accessToken = e : sessionStorage.accessToken = e, o.defaults.headers.common.Authorization = "Bearer " + e)), sessionStorage.accessToken || localStorage.accessToken }, l = function (e) { return "clear" == e ? void delete localStorage.associating : (e && (localStorage.associating = e), localStorage.associating) }, u = function (e) { return "clear" == e ? void delete localStorage.redirectTarget : (e && (localStorage.redirectTarget = e), localStorage.redirectTarget) }, d = function (o, a, s) { var i = n.defer(); return o.error ? i.reject({ message: o.error }) : c() && l() ? (l("clear"), u("clear"), e.addExternalLogin(c(), o.access_token).success(function () { i.resolve() })) : e.getUserInfo(o.access_token).success(function (e) { e.hasRegistered ? (c(o.access_token, s), f.user = e, f.redirectAuthenticated(u() || r.urls.home), r.events.login && r.events.login(f, e), i.resolve(f.user)) : (f.externalUser = e, f.externalUser.access_token = o.access_token, f.externalUser.provider = a, null != s && (localStorage.rememberMe = s), t.path(r.urls.registerExternal), i.reject()) }), i.promise }, g = function () { if (-1 != t.path().indexOf("access_token")) { var n = i(t.path().substring(1)); if (window.opener) window.opener.external_data = n, window.close(); else { var o = u(); t.path(o || r.urls.home); var a = JSON.parse(localStorage.loginProvider), s = !1; localStorage.rememberMe && (s = JSON.parse(localStorage.rememberMe), delete localStorage.rememberMe), delete localStorage.loginProvider, d(n, a, s) } } c() && (c(c()), e.getUserInfo(c()).success(function (e) { f.user = e, r.events.reloadUser && r.events.reloadUser(f, e) })), e.getExternalLogins().success(function (e) { f.externalLogins = e }) }, f = this; return f.user = null, f.externalUser = null, f.externalLogins = [], f.login = function (o) { var t = n.defer(); return o.grant_type = "password", e.login(o).success(function (e) { c(e.access_token, o.rememberMe), f.user = e, f.redirectAuthenticated(u() || r.urls.home), r.events.login && r.events.login(f, e), t.resolve(f.user) }).error(function (e) { c("clear"), t.reject(e) }), t.promise }, f.loginWithExternal = function (e, o) { var t = n.defer(); if (r.usePopups) { var i = window.open(e.url, "frame", "resizeable,height=510,width=380"); a.cancel(s), s = a(function c() { if (!i.closed) return void (s = a(c, 500)); if (r.events.closeOAuthWindow && r.events.closeOAuthWindow(f, window.external_data), "undefined" == typeof window.external_data) return void t.reject(); var n = window.external_data; delete window.external_data, t.resolve(d(n, e, o.rememberMe)) }, 500) } else null != o && null != o.rememberMe && (localStorage.rememberMe = JSON.stringify(o.rememberMe)), localStorage.loginProvider = JSON.stringify(e), window.location.href = e.url; return t.promise }, f.logout = function () { var o = n.defer(); return e.logout().success(function () { f.user = null, c("clear"), u("clear"), r.events.logout && r.events.logout(f), t.path(r.urls.postLogout), o.resolve() }).error(function (e) { c("clear"), o.reject(e) }), o.promise }, f.register = function (o) { var t = n.defer(); return e.register(o).success(function () { r.events.register && r.events.register(f), r.registerThenLogin ? f.login(o).then(function (e) { t.resolve(e) }, function (e) { t.reject(e) }) : t.resolve() }).error(function (e) { t.reject(e) }), t.promise }, f.registerExternal = function () { var r = n.defer(); return f.externalUser ? e.registerExternal(f.externalUser.access_token, f.externalUser).success(function () { r.resolve(f.loginWithExternal(f.externalUser.provider)), f.externalUser = null }).error(function (e) { r.reject(e) }) : r.reject(), r.promise }, f.forgotPassword = function (r) { var o = n.defer(); return e.forgotPassword(r).success(function (e) { o.resolve(e) }).error(function (e) { o.reject(e) }), o.promise }, f.resetPassword = function (r) { var o = n.defer(); return e.resetPassword(r).success(function (e) { o.resolve(e) }).error(function (e) { o.reject(e) }), o.promise }, f.confirmEmail = function (r) { var o = n.defer(); return e.confirmEmail(r).success(function (e) { o.resolve(e) }).error(function (e) { o.reject(e) }), o.promise }, f.mangeInfo = function () { var r = n.defer(); return e.manageInfo().success(function (e) { r.resolve(e) }).error(function (e) { r.reject(e) }), r.promise }, f.changePassword = function (r) { var o = n.defer(); return e.changePassword(r).success(function () { o.resolve() }).error(function (e) { o.reject(e) }), o.promise }, f.addExternalLogin = function (r, o) { var t = n.defer(); return e.addExternalLogin(r, o).success(function () { t.resolve() }).error(function (e) { t.reject(e) }), t.promise }, f.associateExternal = function (e, o) { var t = n.defer(); if (r.usePopups) { var i = window.open(e.url, "frame", "resizeable,height=510,width=380"); a.cancel(s), s = a(function c() { if (!i.closed) return void (s = a(c, 500)); if (r.events.closeOAuthWindow && r.events.closeOAuthWindow(f, window.external_data), "undefined" == typeof window.external_data) return void t.reject(); var n = window.external_data; delete window.external_data, t.resolve(d(n, e, data.rememberMe)) }, 500) } else localStorage.loginProvider = JSON.stringify(e), l(!0), u(o || "/"), window.location.href = e.url; return t.promise }, f.removeLogin = function (r) { var o = n.defer(); return e.removeLogin(r).success(function (e) { o.resolve(e) }).error(function (e) { o.reject(e) }), o.promise }, f.authenticate = function () { c() || (u() || u(t.path()), t.path(r.urls.login)) }, f.redirectAuthenticated = function (e) { c() && (u() && u("clear"), t.path(e)) }, g(), f }] }]);